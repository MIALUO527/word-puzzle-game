<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle Bloom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag Ad SDK -->
  <script src="//libtl.com/sdk.js" data-zone="8976379" data-sdk="show_8976379"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Quicksand', sans-serif;
      background: #fff8f0;
    }

    .page {
      display: none;
      padding: 20px;
      text-align: center;
    }

    .active {
      display: block;
    }

    #petalContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px 0;
    }

    .petal {
      width: 60px;
      height: 60px;
      margin: 6px;
      border-radius: 50%;
      background: #ffe0e0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    .unlocked {
      background: linear-gradient(135deg, #f48fb1, #ce93d8);
    }

    #pointCounter {
      font-size: 1.2rem;
      margin: 12px;
      color: #7c43bd;
      font-weight: bold;
    }

    .btn {
      background: linear-gradient(90deg, #ffd180 60%, #e1bfff 100%);
      color: #7c43bd;
      border: none;
      border-radius: 18px;
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 2px 8px #e1bfff33;
      cursor: pointer;
      margin-top: 20px;
    }

    #status {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #7c43bd;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Home Page -->
  <div id="homePage" class="page active">
    <h1 style="color:#7c43bd;">Welcome to Puzzle Bloom</h1>
    <button class="btn" onclick="startGame()">Start Game</button>
  </div>

  <!-- Game Page -->
  <div id="gamePage" class="page">
    <div id="pointCounter">Bloom Points: <span id="bloomPointValue">0</span></div>
    <div id="petalContainer"></div>
    <button class="btn" onclick="backToHome()">Back</button>

    <!-- Ad Button -->
    <div id="adButtonContainer">
      <div style="font-size: 1rem; color: #7c43bd; margin-top: 20px;">Watch Ad to Earn Reward</div>
      <button id="adBtn" class="btn" onclick="showAd()">‚ñ∂Ô∏è Show Ad</button>
      <div id="status"></div>
    </div>
  </div>

  <!-- Background Music -->
  <audio id="bgMusic" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <script>
    Telegram.WebApp.ready();

    const homePage = document.getElementById('homePage');
    const gamePage = document.getElementById('gamePage');
    const petalContainer = document.getElementById('petalContainer');
    const bloomPointValue = document.getElementById('bloomPointValue');
    const petalStyles = Array(12).fill('unlocked');
    const bgMusic = document.getElementById('bgMusic');
    const adBtn = document.getElementById('adBtn');

    const MAX_AD_VIEWS_PER_DAY = 3;
    const todayKey = `adViewCount_${new Date().toISOString().split('T')[0]}`;
    let adViewCount = parseInt(localStorage.getItem(todayKey) || '0');

    function updateAdButtonState() {
      if (adViewCount >= MAX_AD_VIEWS_PER_DAY) {
        adBtn.disabled = true;
        adBtn.textContent = 'Limit Reached';
      } else {
        adBtn.disabled = false;
        adBtn.textContent = '‚ñ∂Ô∏è Show Ad';
      }
    }

    function startGame() {
      homePage.classList.remove('active');
      gamePage.classList.add('active');
      bgMusic.play();
      updateAdButtonState();
    }

    function backToHome() {
      gamePage.classList.remove('active');
      homePage.classList.add('active');
      bgMusic.pause();
    }

    function getBloomPoint() {
      return parseInt(localStorage.getItem('bloomPoint') || '0');
    }

    function setBloomPoint(value) {
      localStorage.setItem('bloomPoint', value);
      bloomPointValue.textContent = value;
    }

    function unlockPetal(index) {
      const petal = document.createElement('div');
      petal.className = 'petal unlocked';
      petalContainer.appendChild(petal);
    }

    function showToast(text, icon) {
      const toast = document.createElement('div');
      toast.textContent = `${icon} ${text}`;
      toast.style.position = 'fixed';
      toast.style.bottom = '20px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.background = '#fff';
      toast.style.border = '1px solid #ccc';
      toast.style.borderRadius = '12px';
      toast.style.padding = '10px 16px';
      toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      toast.style.zIndex = 9999;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    function showAd() {
      const status = document.getElementById('status');
      status.textContent = 'Loading ad...';

      show_8976379()
        .then(() => {
          adViewCount++;
          localStorage.setItem(todayKey, adViewCount);
          updateAdButtonState();

          status.textContent = '‚úÖ Reward granted!';
          let current = getBloomPoint();
          setBloomPoint(current + 1);
          unlockPetal(current % petalStyles.length);
          showToast('+1 Bloom Point!', 'üå∏');
        })
        .catch(() => {
          status.textContent = '‚ö†Ô∏è Ad skipped or failed. Please try again later.';
        });
    }

    window.onload = () => {
      const point = getBloomPoint();
      setBloomPoint(point);
      for (let i = 0; i < point; i++) unlockPetal(i % petalStyles.length);
    };
  </script>
</body>
</html>
