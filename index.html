<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle Bloom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag Ad SDK -->
  <script src="//libtl.com/sdk.js" data-zone="8976379" data-sdk="show_8976379"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Quicksand', sans-serif;
      background: #fff8f0;
    }

    .page {
      display: none;
      padding: 20px;
      text-align: center;
    }

    .active {
      display: block;
    }

    #puzzleContainer {
      width: 300px;
      height: 300px;
      display: flex;
      flex-wrap: wrap;
      margin: 20px auto;
      border: 2px solid #ccc;
      background: #fdfdfd;
    }

    .puzzle-piece {
      width: 100px;
      height: 100px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background-color: #e1bfff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #7c43bd;
      cursor: grab;
    }

    .btn {
      background: linear-gradient(90deg, #ffd180 60%, #e1bfff 100%);
      color: #7c43bd;
      border: none;
      border-radius: 18px;
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 2px 8px #e1bfff33;
      cursor: pointer;
      margin-top: 20px;
    }

    #status {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #7c43bd;
      font-weight: 600;
    }

    #adButtonContainer {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 999;
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div id="homePage" class="page active">
    <h1 style="color:#7c43bd;">Welcome to Puzzle Bloom</h1>
    <button class="btn" onclick="startGame()">Start Game</button>
  </div>

  <div id="gamePage" class="page">
    <div id="puzzleContainer"></div>
    <button class="btn" onclick="backToHome()">Back</button>

    <div id="adButtonContainer">
      <button id="adBtn" class="btn" onclick="showAd()">▶️ Show Ad</button>
      <div id="status"></div>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();

    const homePage = document.getElementById('homePage');
    const gamePage = document.getElementById('gamePage');
    const puzzleContainer = document.getElementById('puzzleContainer');
    const adBtn = document.getElementById('adBtn');

    const MAX_AD_VIEWS_PER_DAY = 3;
    const todayKey = `adViewCount_${new Date().toISOString().split('T')[0]}`;
    let adViewCount = parseInt(localStorage.getItem(todayKey) || '0');

    const pieces = [];

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createPuzzle() {
      puzzleContainer.innerHTML = '';
      pieces.length = 0;
      for (let i = 1; i <= 9; i++) {
        const piece = document.createElement('div');
        piece.className = 'puzzle-piece';
        piece.draggable = true;
        piece.textContent = i;
        piece.dataset.index = i;
        pieces.push(piece);
      }
      shuffleArray(pieces).forEach(piece => puzzleContainer.appendChild(piece));
    }

    puzzleContainer.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', e.target.dataset.index);
    });

    puzzleContainer.addEventListener('dragover', e => {
      e.preventDefault();
    });

    puzzleContainer.addEventListener('drop', e => {
      e.preventDefault();
      const draggedIndex = e.dataTransfer.getData('text/plain');
      const target = e.target;
      if (target.classList.contains('puzzle-piece')) {
        const dragged = [...puzzleContainer.children].find(p => p.dataset.index === draggedIndex);
        if (dragged && dragged !== target) {
          const draggedClone = dragged.cloneNode(true);
          const targetClone = target.cloneNode(true);

          puzzleContainer.replaceChild(draggedClone, target);
          puzzleContainer.replaceChild(targetClone, dragged);
        }
      }
    });

    function updateAdButtonState() {
      if (adViewCount >= MAX_AD_VIEWS_PER_DAY) {
        adBtn.disabled = true;
        adBtn.textContent = 'Limit Reached';
      } else {
        adBtn.disabled = false;
        adBtn.textContent = '▶️ Show Ad';
      }
    }

    function startGame() {
      homePage.classList.remove('active');
      gamePage.classList.add('active');
      createPuzzle();
      updateAdButtonState();
    }

    function backToHome() {
      gamePage.classList.remove('active');
      homePage.classList.add('active');
    }

    function showAd() {
      const status = document.getElementById('status');
      status.textContent = 'Loading ad...';

      show_8976379()
        .then(() => {
          adViewCount++;
          localStorage.setItem(todayKey, adViewCount);
          updateAdButtonState();
          status.textContent = '✅ Reward granted!';
        })
        .catch(() => {
          status.textContent = '⚠️ Ad skipped or failed. Please try again later.';
        });
    }
  </script>
</body>
</html>
